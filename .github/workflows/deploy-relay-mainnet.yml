name: deploy-relay-mainnet

on:
  push:
    branches: [ mainnet ]
  workflow_dispatch: {}

jobs:
  deploy-relay-mainnet:
    runs-on: ubuntu-latest
    environment:
      name: mainnet
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
      RECOVER_EMAIL_RECIPIENT: ${{ vars.VITE_RECOVER_EMAIL_RECIPIENT }}
      NEAR_RPC_URL: ${{ vars.VITE_NEAR_RPC_URL }}
      NETWORK_ID: ${{ vars.VITE_NEAR_NETWORK }}
      EMAIL_DKIM_VERIFIER_CONTRACT: ${{ vars.VITE_EMAIL_DKIM_VERIFIER_CONTRACT }}
      WORKER_NAME: w3a-relay-mainnet
      # Optional: Threshold signing (2p FROST; derived relayer share)
      THRESHOLD_ED25519_SHARE_MODE: derive
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add wasm target
        run: rustup target add wasm32-unknown-unknown

      - name: Install wasm-pack
        run: |
          curl -sSf https://rustwasm.github.io/wasm-pack/installer/init.sh | sh

      - name: Setup Bun (for worker bundling step in build scripts)
        uses: oven-sh/setup-bun@v2

      - name: Install deps (workspace)
        run: pnpm install --no-frozen-lockfile

      - name: Build SDK (sdk, production) for Worker bundling
        run: pnpm build:sdk-prod

      - name: Deploy Cloudflare Worker (relay)
        run: |
          set -euo pipefail
          # Wrangler/undici rejects header values containing newlines; GitHub secrets can accidentally
          # include a trailing newline if pasted from a file.
          if [ -n "${CLOUDFLARE_API_TOKEN:-}" ]; then
            CLOUDFLARE_API_TOKEN="$(printf '%s' "$CLOUDFLARE_API_TOKEN" | tr -d '\r\n')"
            export CLOUDFLARE_API_TOKEN
          fi

          if [ -z "${RECOVER_EMAIL_RECIPIENT:-}" ]; then
            echo "VITE_RECOVER_EMAIL_RECIPIENT env var is not set in this GitHub Environment" >&2
            exit 1
          fi

          # Build worker vars (avoid setting empty strings).
          #
          # Wrangler expects `--var name:value` (colon), not `name=value`.
          # If we pass `name=value`, Wrangler will treat the whole string as the variable name,
          # which shows up in the Cloudflare dashboard as a variable named `NAME=value`.
          ARGS=(--var "RECOVER_EMAIL_RECIPIENT:${RECOVER_EMAIL_RECIPIENT}")
          ARGS+=(--var "THRESHOLD_ED25519_SHARE_MODE:${THRESHOLD_ED25519_SHARE_MODE}")
          if [ -n "${NEAR_RPC_URL:-}" ]; then
            ARGS+=(--var "NEAR_RPC_URL:${NEAR_RPC_URL}")
          fi
          if [ -n "${NETWORK_ID:-}" ]; then
            ARGS+=(--var "NETWORK_ID:${NETWORK_ID}")
          fi
          if [ -n "${EMAIL_DKIM_VERIFIER_CONTRACT:-}" ]; then
            ARGS+=(--var "EMAIL_DKIM_VERIFIER_CONTRACT:${EMAIL_DKIM_VERIFIER_CONTRACT}")
          fi

          pnpm -C examples/relay-cloudflare-worker exec wrangler deploy --config wrangler.toml --env mainnet "${ARGS[@]}"

      - name: Configure Email Routing for RECOVER_EMAIL_RECIPIENT
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          set -euo pipefail
          if [ -n "${CF_API_TOKEN:-}" ]; then
            CF_API_TOKEN="$(printf '%s' "$CF_API_TOKEN" | tr -d '\r\n')"
          fi
          if [ -z "${CF_ZONE_ID:-}" ]; then
            echo "CLOUDFLARE_ZONE_ID (GitHub Environment Secret) is required to configure Email Routing" >&2
            exit 1
          fi
          if [ -z "${RECOVER_EMAIL_RECIPIENT:-}" ]; then
            echo "VITE_RECOVER_EMAIL_RECIPIENT (GitHub Environment Var) is required to configure Email Routing" >&2
            exit 1
          fi
          if [ -z "${WORKER_NAME:-}" ]; then
            echo "WORKER_NAME env var is not set in this GitHub Environment" >&2
            exit 1
          fi
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq is required on the runner to manage Cloudflare Email Routing rules" >&2
            exit 1
          fi

          API_BASE="https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/email/routing/rules"
          auth=(-H "Authorization: Bearer $CF_API_TOKEN" -H "Content-Type: application/json")

          echo "Ensuring Email Routing rule for ${RECOVER_EMAIL_RECIPIENT} â†’ ${WORKER_NAME}"

          existing="$(curl -sS -X GET "$API_BASE" "${auth[@]}")"
          echo "$existing" | jq -e '.success == true' >/dev/null || { echo "$existing"; exit 1; }

          # Delete any existing rules for this recipient.
          rule_ids="$(echo "$existing" | jq -r --arg r "$RECOVER_EMAIL_RECIPIENT" '.result[]? | select(.matchers[]? | (.value? == $r)) | .id')"
          if [ -n "${rule_ids:-}" ]; then
            echo "$rule_ids" | while read -r id; do
              [ -z "${id:-}" ] && continue
              echo "Deleting existing Email Routing rule id=$id for ${RECOVER_EMAIL_RECIPIENT}"
              del="$(curl -sS -X DELETE "$API_BASE/$id" "${auth[@]}")"
              echo "$del" | jq -e '.success == true' >/dev/null || { echo "$del"; exit 1; }
            done
          fi

          create="$(curl -sS -X POST "$API_BASE" "${auth[@]}" --data @- << JSON
          {
            "enabled": true,
            "name": "${RECOVER_EMAIL_RECIPIENT} to ${WORKER_NAME}",
            "matchers": [
              {
                "type": "literal",
                "field": "to",
                "value": "${RECOVER_EMAIL_RECIPIENT}"
              }
            ],
            "actions": [
              {
                "type": "worker",
                "value": ["${WORKER_NAME}"]
              }
            ]
          }
          JSON
          )"
          echo "$create" | jq -e '.success == true' >/dev/null || { echo "$create"; exit 1; }
