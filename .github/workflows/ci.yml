name: ci

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies (workspace)
        run: pnpm install --no-frozen-lockfile

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add wasm32 target
        run: rustup target add wasm32-unknown-unknown

      - name: Install wasm-pack
        run: |
          curl -sSf https://rustwasm.github.io/wasm-pack/installer/init.sh | sh

      - name: Setup Bun (for worker bundling)
        uses: oven-sh/setup-bun@v2

      - name: Install Playwright (Chromium + system deps)
        run: pnpm -C sdk exec playwright install --with-deps chromium

      - name: Generate WASM TypeScript types (wasm-pack)
        run: pnpm -C sdk exec bash ./scripts/generate-types.sh

      - name: Type-check SDK
        run: pnpm -C sdk type-check

      - name: Build SDK (production)
        run: pnpm build:sdk-prod

      - name: Assert generated palette CSS
        run: node sdk/scripts/assert-palette-css.mjs

      - name: Run wallet-iframe tests
        env:
          USE_RELAY_SERVER: '1'
          NO_CADDY: '1'
          VITE_WALLET_DEV_CSP: 'strict'
        run: pnpm -C sdk test:wallet-iframe

      - name: Run lit-components tests
        env:
          NO_CADDY: '1'
          VITE_WALLET_DEV_CSP: 'strict'
        run: pnpm -C sdk test:lit-components

      - name: Run unit tests
        env:
          NO_CADDY: '1'
          VITE_WALLET_DEV_CSP: 'strict'
        run: pnpm -C sdk test:unit

      - name: Run relayer (server) tests
        run: pnpm -C sdk test:relayer
