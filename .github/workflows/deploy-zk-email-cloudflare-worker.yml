name: deploy-zk-email-cloudflare-worker

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment (must match GitHub Environment name with secrets)"
        required: false
        default: "production"

jobs:
  deploy-zk-email-worker:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Wrangler
        run: pnpm add -g wrangler@4

      - name: Deploy zk-email Cloudflare Worker
        working-directory: examples/zk-email-cloudflare-worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          wrangler deploy

      - name: Configure Email Routing for reset@web3authn.org
        if: env.CLOUDFLARE_ZONE_ID != ''
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          set -euo pipefail
          API="https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/email/routing/rules"
          echo "Creating Email Routing rule for reset@web3authn.org â†’ zk-email-cloudflare-worker"
          # NOTE: Payload schema may need adjustment to match the latest
          # Cloudflare Email Routing API. See Cloudflare docs for details.
          curl -sS -X POST "$API" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data @- << 'JSON'
          {
            "enabled": true,
            "name": "reset@web3authn.org to zk-email-cloudflare-worker",
            "matchers": [
              {
                "type": "recipient",
                "value": "reset@web3authn.org"
              }
            ],
            "actions": [
              {
                "type": "worker",
                "value": {
                  "worker": {
                    "name": "zk-email-cloudflare-worker"
                  }
                }
              }
            ]
          }
          JSON

