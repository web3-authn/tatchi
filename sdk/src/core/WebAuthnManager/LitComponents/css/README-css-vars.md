# Theme and CSS Variables: How it works

This document explains how theme colors and CSS variables are defined, generated, loaded, and consumed by Lit components in the Web3Auth SDK.

## Sources of truth

- `sdk/src/theme/palette.json`
  - Canonical color scales (grey, slate, cream), chroma families (blue, red, …), and gradients.
  - Optional `tokens` object for single‑point overrides (e.g., `{"buttonBackground": "..."}`).

- `sdk/src/base-styles.ts` (import as `@/base-styles`)
  - Builds tokens from `palette.json` via `createThemeTokens` in `sdk/src/theme/base-styles.js` and exports:
    - `DARK_THEME`, `LIGHT_THEME`, and `CREAM_THEME`.
  - These define the semantic aliases components use (textPrimary, surface, borderPrimary, …).

## Generated CSS: `w3a-components.css`

- Generator: `node sdk/scripts/generate-w3a-components-css.mjs`
  - Reads `palette.json` + the same mappings produced by `createThemeTokens` in `sdk/src/theme/base-styles.js`.
  - Emits a single stylesheet at:
    - `sdk/src/core/WebAuthnManager/LitComponents/css/w3a-components.css`
  - Do not edit this file by hand; re‑run the generator instead.

- What it contains (host‑scoped, Shadow‑DOM friendly):
  - Default dark alias tokens applied directly on Web3Auth custom element hosts:
    - `w3a-tx-tree, w3a-drawer, w3a-modal-tx-confirmer, w3a-drawer-tx-confirmer, w3a-tx-confirm-content, w3a-halo-border, w3a-passkey-halo-loading, w3a-export-key-viewer { --w3a-colors-* }`
  - Theme overrides scoped by a document attribute and again limited to hosts:
    - `:root[data-w3a-theme="light"] <hosts> { --w3a-colors-* }`
    - `:root[data-w3a-theme="cream"] <hosts> { --w3a-colors-* }`

Why host‑scoped? Custom properties set on the component host are inherited by descendants inside Shadow DOM. This removes the need for global `:root` variables and makes tokens travel with the component boundary.

## Selecting a theme

- Set a document attribute on the root element:
  - `document.documentElement.setAttribute('data-w3a-theme', 'dark' | 'light' | 'cream')`
  - Defaults to “dark” if not set.
- Containers that own the UI (e.g., `w3a-modal-tx-confirmer`, `w3a-drawer-tx-confirmer`) will keep this in sync when their `theme` attribute changes.

## Loading styles (CSP + Shadow DOM)

We avoid inline `<style>` text for strict CSP environments and prefer external assets loaded once per document. Components use a small helper to ensure CSS is available:

- `sdk/src/core/WebAuthnManager/LitComponents/css/css-loader.ts`
  - `ensureExternalStyles(root, assetName, markerAttr)`
  - Strategy:
    - If `root` is a ShadowRoot and constructable stylesheets are supported, fetch and adopt the CSS.
    - If inside `about:srcdoc`, inject a scoped `@import` style (CSP exceptions apply inside srcdoc).
    - Otherwise, add a document‑level `<link rel="stylesheet">` once marked with `markerAttr`.

Where we ensure the tokens are present:
- `w3a-modal-tx-confirmer` (viewer-modal.ts): ensures `w3a-components.css` at document level.
- `w3a-tx-confirm-content` (tx-confirm-content.ts): pre‑ensures `w3a-components.css` at document level.
- `ExportPrivateKey` viewer also ensures tokens.

Note: `@import` inside constructable stylesheets is ignored by browsers. Do not rely on `@import` for tokens; ensure `w3a-components.css` with `ensureExternalStyles` or a regular `<link>`.

## Consuming tokens in components

- Components read semantic aliases such as `--w3a-colors-textPrimary`, `--w3a-colors-surface`, etc.
- Component‑specific variables are layered on top using component selectors or host attributes.
- Example (excerpt from `tx-tree.css`):
  - Theme blocks define component variables under `[theme="dark"]` / `[theme="light"]`.
  - Contextual variables (e.g., `--indent`, `--connector-indent`) are applied via utility classes near the top of the file for clarity.

## Regenerating tokens

- From repo root or inside `sdk/`:
  - `node sdk/scripts/generate-w3a-components-css.mjs`
- Verify changes to `sdk/src/core/WebAuthnManager/LitComponents/css/w3a-components.css` and commit.

## Customizing the palette

- Edit `sdk/src/theme/palette.json`:
  - Adjust any scale values, chroma families, or gradients.
  - Optional flat overrides: `{ "tokens": { "buttonBackground": "#..." } }`.
- Re‑run the generator to propagate changes to all components.

## Best practices

- Do not attach theme tokens to `:root` globally. Keep them host‑scoped so Shadow DOM inherits correctly and to avoid collisions with host app CSS.
- Ensure `w3a-components.css` is loaded once by your host app if you use components outside the provided containers. In frameworks, a single `<link>` is usually sufficient:

```html
<link rel="stylesheet" href="/path/to/w3a-components.css" data-w3a-components-css>
```

- Switch themes by toggling `data-w3a-theme` on `document.documentElement`.

## Known limitations/notes

- Constructable stylesheets ignore `@import`; always ensure `w3a-components.css` via `<link>` or the loader.
- With host‑scoped tokens, any non‑W3A UI in your app that wants to use the same variables must include `w3a-components.css` and opt‑in to reading `--w3a-colors-*` or define its own mapping.

---

If anything here drifts from the implementation:
- Check `generate-w3a-components-css.mjs` and `src/theme/base-styles.js` for the current mapping and output shape.
- Search for `ensureExternalStyles(…, 'w3a-components.css' …)` to see which entrypoints ensure tokens.
