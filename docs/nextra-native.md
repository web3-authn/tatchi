# Plan: Move the Native Site to Nextra (example.localhost)

This plan replaces the Vite/VitePress setup with a single Nextra-powered Next.js application that serves both the marketing homepage and documentation. Nextra lets us import existing React components directly, so the current homepage UI (`examples/tatchi-docs/src/pages/HomePage.tsx`) can render without web-component wrappers.

## Target Outcome
- `https://example.localhost/` is served by a Nextra homepage that composes the existing React UI (Navbar, HomePage, Toaster, providers).
- `https://example.localhost/docs` loads the documentation section managed by Nextra MDX routes.
- The `examples/tatchi-docs` package becomes a Next.js/Nextra workspace; Vite, VitePress, and related dev servers/Caddy routes are removed for the root site.
- A single `next dev` / `next build` pipeline ships the entire site.

## Architecture Snapshot
- **Dev:** `next dev` (port 3000 by default) proxied by Caddy as the `example.localhost` origin. Wallet/relayer hosts stay untouched.
- **Build:** `next build && next export` (or deployment to a Node/Edge host) produces a statically generated Nextra site under `examples/tatchi-docs/out`.
- **Content organization:** 
  - `pages/index.tsx` → homepage using the existing React components.
  - `pages/docs/**/*.mdx` (or `.md`) → Nextra documentation tree.
  - Shared UI/components live in `examples/tatchi-docs/src/**`, imported by both homepage and docs via MDX.

---

## Step 1 — Convert `examples/tatchi-docs` into a Next.js Workspace
1. Remove Vite-specific entry points that are no longer needed:
   - Delete `index.html`, `vite.config.ts`, `vite-env.d.ts`, and Vite-only scripts from `package.json`.
   - Drop dev scripts such as `pnpm dev -- --host example.localhost`.
2. Install Nextra + Next.js dependencies:
   ```bash
   pnpm add next react react-dom nextra nextra-theme-docs -w --filter examples/tatchi-docs
   pnpm add @types/node @types/react @types/react-dom typescript -D --filter examples/tatchi-docs
   ```
3. Replace `tsconfig.json` with a Next.js-flavoured config (extends `next/tsconfig` and points to `src` for absolute imports).
4. Add the required Next.js project files:
   - `next-env.d.ts` (generated by running `next` once).
   - `next.config.mjs` configured with Nextra.
   - Optional `eslint` and `postcss` configs if we keep Tailwind or custom CSS tooling.

Reference: [Nextra installation guide](https://nextra.site/docs/getting-started).

---

## Step 2 — Configure Nextra
1. Create `next.config.mjs` that wraps Nextra:
   ```js
   import nextra from 'nextra';

   const withNextra = nextra({
     theme: 'nextra-theme-docs',
     themeConfig: './theme.config.tsx',
     mdxOptions: {
       remarkPlugins: [],
       rehypePlugins: [],
     },
   });

   export default withNextra({
     reactStrictMode: true,
     trailingSlash: true,
     output: 'export', // enables `next export` for static output
   });
   ```
2. Add `theme.config.tsx` with sidebar, footer, logo, GitHub links, etc. This is the equivalent of the current VitePress theme config.
3. Define `pages/_app.tsx` to wire global providers (fonts, global CSS, analytics).
4. Move existing global CSS (`src/index.css`) to `styles/globals.css` (import from `_app.tsx`). Keep component-scoped CSS modules where helpful.

---

## Step 3 — Home Page Composition
1. Move `examples/tatchi-docs/src/pages/HomePage.tsx` and related components into a Next-friendly structure, e.g.:
   ```
   examples/tatchi-docs/
   ├─ src/
   │  ├─ components/
   │  │  ├─ Navbar.tsx
   │  │  ├─ ToasterThemed.tsx
   │  │  └─ ...
   │  └─ features/
   └─ pages/
      └─ index.tsx        // Next.js page
   ```
2. Implement `pages/index.tsx` using the new `TatchiPasskeyProvider` (Theme + PasskeyProvider):
```tsx
import { TatchiPasskeyProvider } from '@tatchi/sdk/react';
import HomePage from '@/components/HomePage';
import Navbar from '@/components/Navbar';
import ToasterThemed from '@/components/ToasterThemed';

export default function Landing() {
  const env = process.env;
  return (
    <TatchiPasskeyProvider
      config={{ /* map env vars to SDK config */ }}
      theme={{ as: 'div', className: 'app-theme-scope' }}
    >
      <Navbar />
      <main>
        <HomePage />
      </main>
      <ToasterThemed />
    </TatchiPasskeyProvider>
  );
}
```
3. Replace `import.meta.env` with `process.env` (Next exposes `NEXT_PUBLIC_*` env vars to the client). Update `.env` files accordingly (`NEXT_PUBLIC_RELAYER_URL`, etc.).
4. Keep CCA tokens, layout, and toast behaviour identical to today—no Shadow DOM required.

---

## Step 4 — Documentation Structure in Nextra
1. Create a `pages/docs/` directory mirroring the current docs tree. Each Markdown file becomes an MDX page:
   - Migrate the existing `.md` / `.mdx` docs into this folder.
   - Use `_meta.json` files to describe sidebar order per directory (see [Nextra routing docs](https://nextra.site/docs/docs-theme/sidebar)).
2. For shared content:
   - Move reusable snippets/components into `src/docs/components`.
   - Import React components directly inside MDX (`import Alert from '@/docs/components/Alert'`).
3. Configure frontmatter such as `title`, `description`, `hero`, and `toc` to reproduce the current Vite docs experience.

---

## Step 5 — Local Development & Caddy
1. Add workspace scripts in the root `package.json`:
   ```json
   {
     "scripts": {
       "site:dev": "pnpm --filter examples/tatchi-docs dev",
       "site:build": "pnpm --filter examples/tatchi-docs build",
       "site:export": "pnpm --filter examples/tatchi-docs export"
     }
   }
   ```
   and in `examples/tatchi-docs/package.json`:
   ```json
   {
     "scripts": {
       "dev": "next dev",
       "build": "next build",
       "export": "next export",
       "start": "next start"
     }
   }
   ```
2. Update `examples/tatchi-docs/Caddyfile` to proxy the Next.js dev server:
   ```caddy
   example.localhost {
     tls internal
     encode gzip
     reverse_proxy localhost:3000
   }
   ```
   Remove the Vite-specific reverse proxies for `/docs`.
3. Keep wallet and relayer Caddy configs unchanged; only the root site switches to Next.js.

---

## Step 6 — Build & Deployment
1. For static hosting (e.g., Cloudflare Pages, Netlify, S3):
   - Run `pnpm site:build && pnpm site:export`.
   - Deploy the `examples/tatchi-docs/out` directory.
2. For serverful hosting (Node/Edge runtime):
   - Run `pnpm site:build`.
   - Serve via `next start` or the hosting provider’s Next.js adapter.
3. Update any CI workflows (`.github/workflows/deploy-cloudflare.yml`) to call the new scripts and deploy the Nextra output instead of the Vite build.

---

## Step 7 — Match the VitePress Dark Theme
Recreate the VitePress-inspired dark palette and typography from the screenshot for consistent branding.

1. **Extend the docs theme config.** Add palette metadata to `examples/tatchi-docs/theme.config.tsx` using the Nextra Docs theme options:
   ```tsx
   import type { DocsThemeConfig } from 'nextra-theme-docs';

   const config: DocsThemeConfig = {
     logo: <span className="font-semibold text-sky-200">Tatchi</span>,
     project: { link: 'https://github.com/tatchi-labs/web3-authn-sdk' },
     docsRepositoryBase: 'https://github.com/tatchi-labs/web3-authn-sdk/tree/main/docs',
     sidebar: { defaultMenuCollapseLevel: 1 },
     footer: { text: 'Tatchi · Passkey SDK' },
     primaryHue: 210, // slate/blue accent similar to VitePress
     primarySaturation: 65,
     useNextSeoProps() {
       return { titleTemplate: '%s | Tatchi Docs' };
     },
   };

   export default config;
   ```
   This sets the default accent hue and headline styling to mirror the indigo highlights in the reference UI.

2. **Override global colors and typography.** Import Nextra defaults in `styles/globals.css`, then layer custom variables to match the dark slate background and elevated cards:
   ```css
   @import 'nextra-theme-docs/style.css';

   :root {
     --nextra-primary-hue: 210;
     --nextra-primary-saturation: 65%;
     --nextra-primary-foreground: 210 100% 87%;
     --nextra-background: 222 47% 9%;
     --nextra-navbar-background: rgba(13, 17, 23, 0.85);
     --nextra-sidebar-background: rgba(15, 23, 42, 0.95);
     --nextra-content-background: rgba(17, 24, 39, 0.9);
     --nextra-border: rgba(148, 163, 184, 0.12);
     --nextra-code-background: #11182b;
     --nextra-code-shadow: 0 0 0 1px rgba(15, 23, 42, 0.6);
     font-feature-settings: 'ss04' on, 'cv02' on;
   }

   html.dark body {
     background-color: hsl(var(--nextra-background));
     color: rgb(226 232 240);
   }

   .nextra-content h1,
   .nextra-content h2 {
     color: rgb(226 241 255);
     letter-spacing: -0.01em;
   }

   .nextra-focusable,
   .nextra-sidebar nav a[aria-current='page'] {
     background-color: rgba(59, 130, 246, 0.08);
     color: rgb(186 230 253);
   }
   ```
   Adjust hues or alpha levels (`rgba`) until the preview matches the screenshot’s soft-contrast panels and highlight color.

3. **Refine code highlighting.** Configure Shiki or Prism (whichever the project prefers) in `next.config.mjs` or via `theme.config.tsx` to use a dark operator theme such as `poimandres` or `dracula-soft`, aligning code blocks with the screenshot.

4. **Disable sidebar animations.** Override the accordion transitions so expanding/collapsing sections happens instantly:
   ```css
   .nextra-sidebar nav details,
   .nextra-sidebar nav summary,
   .nextra-sidebar nav details[open] > summary::after,
   .nextra-sidebar nav details > summary::after {
     transition-duration: 0ms !important;
     transition-delay: 0ms !important;
   }

   .nextra-sidebar nav details[open] > summary ~ * {
     transition: none !important;
   }
   ```
   Apply similar overrides to any additional sidebar animation classes introduced by future Nextra releases.

5. **Preview and iterate.** Run `pnpm site:dev` and compare `/docs` against the shared screenshot. Fine-tune CSS variables (and animation overrides) until the layout feels identical.

---

## Step 8 — Remove Vite Legacy Footprints
- Delete `examples/vite`, `examples/vite-secure`, and other Vite-specific bundles once the Nextra site is stable (or archive them under `/legacy`).
- Clean up workspace references:
  - Remove their entries from `pnpm-workspace.yaml`.
  - Delete unused npm scripts, env.example files, and Caddy routes.
- Ensure SDK examples that still rely on Vite (e.g., wallet demos) remain intact; only the native docs/homepage stack should change.

---

## Testing & Risks
- **Env parity:** Translate all `VITE_*` env vars to `NEXT_PUBLIC_*` and server-only keys to `process.env.*`. Audit `.env` files and CI secrets.
- **React 18 strict mode:** Next.js renders components twice in dev; verify providers/components handle double-invocation without side effects.
- **Static export constraints:** Features relying on request-time data need to move behind APIs (`pages/api`) or use client fetches; confirm the docs and homepage remain purely static.
- **Asset paths:** Nextra serves assets from `/` by default. Confirm images/fonts referenced in docs still resolve (update to use `/public/**` or `import` URLs as needed).
- **MDX imports:** Components used in MDX must be ESM-compatible. Convert any CommonJS helpers to ES modules.
- **Navigation:** Recreate header/footer/nav from VitePress in `theme.config.tsx` to maintain UX continuity.

---

## Checklist
- [ ] Nextra/Next.js dependencies installed; `next.config.mjs` committed.
- [ ] Homepage migrated to `pages/index.tsx` with existing React components.
- [ ] Docs migrated to `pages/docs/**` with `_meta.json` defining sidebar order.
- [ ] Env variables renamed to `NEXT_PUBLIC_*` and consumed via `process.env`.
- [ ] Caddy dev proxy updated to `next dev` (`localhost:3000`).
- [ ] CI workflows and workspace scripts updated to call `next build` / `next export`.
- [ ] Dark theme customized to match the VitePress reference screenshot.
- [ ] Legacy Vite assets removed or archived after the Nextra site is verified.
