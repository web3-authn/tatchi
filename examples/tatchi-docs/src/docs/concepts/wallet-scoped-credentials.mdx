# Wallet‑Scoped vs App‑Scoped Credentials (rpId strategy)

This doc explains two deployment patterns for WebAuthn `rpId` and how to choose between them. Your choice affects which passkeys are shown to users and how you integrate across origins.

Terms
- `rpId`: Relying Party ID. A registrable domain (no scheme/port). Passkeys are bound to this value.
- Wallet origin: The domain that hosts the wallet iframe/service, e.g. `wallet.example.com` or `web3authn.org`.
- App origin: The domain of the embedding application, e.g. `app.example.com` or `example.com`.

Option A — Wallet‑Scoped Credentials
- `rpId = <wallet domain>` (e.g., `web3authn.org` or `wallet.example.com`).
- Behaves like an auth server: a single passkey is reusable across many apps that integrate the wallet.
- Top‑level execution is required for cross‑origin flows; and when the app and wallet live on different registrable sites, Related Origin Requests (ROR) must be enabled so the parent can call WebAuthn using the wallet `rpId`.

Pros
- One credential per user, reusable across multiple apps.
- Clear trust boundary on the wallet provider domain.

Cons
- When the wallet is embedded cross‑origin, Safari blocks in‑iframe WebAuthn. The SDK bridges calls to the top‑level; if the top‑level origin differs from the wallet `rpId`, you must enable ROR.
- Firefox currently lacks broad ROR support; plan an app‑scoped fallback or show a developer‑facing guidance message on that browser.
- Migrating to a different `rpId` later won’t show existing credentials.

How to implement (Option A)
1) Choose the wallet domain as your rpId
   - Set `iframeWallet.rpIdOverride = '<wallet-domain>'` (for example, `web3authn.org`).
   - The SDK passes this rpId to `navigator.credentials.create/get()`.
2) Enable top‑level bridge (already implemented)
   - The wallet iframe attempts WebAuthn in‑iframe; if Safari throws the ancestor/focus errors, it bridges to the parent via `postMessage`. The parent runs WebAuthn at top‑level and returns a serialized credential.
3) Enable ROR when app and wallet are on different registrable sites
   - Host `/.well-known/webauthn` on the wallet origin (it can be a dynamic route) with JSON listing allowed top‑level app origins:
     
     ```json
     {
       "origins": [
         "https://app.example.com",
         "https://another-app.example.com"
       ]
     }
     ```
   - With ROR (supported in Chromium/WebKit), the top‑level app can execute WebAuthn using `rp.id = '<wallet-domain>'` even though it runs on a different site. Firefox may not honor this yet.
4) Permissions Policy and iframe `allow`
   - Parent response header should delegate:
     `Permissions-Policy: publickey-credentials-get=(self \"<wallet-origin>\") , publickey-credentials-create=(self \"<wallet-origin>\")`
   - Iframe `allow` is set by the SDK; ensure your CSP does not block it.

Config snippet (Option A)
```ts
const passkey = new PasskeyManager({
  ...PASSKEY_MANAGER_DEFAULT_CONFIGS,
  relayer: { url: '…', accountId: '…' },
  iframeWallet: {
    walletOrigin: 'https://wallet.example.com',
    walletServicePath: '/service',
    rpIdOverride: 'wallet.example.com',
    // Optional: allow Safari GET fallback when in an iframe
    enableSafariGetWebauthnRegistrationFallback: true,
  },
});
```

Option B — App‑Scoped Credentials
- `rpId = <app base domain>` (e.g., `example.com` or `example.localhost`).
- Passkeys are bound to the app’s base domain and work across its subdomains (e.g., `app.example.com`, `wallet.example.com`).
- Recommended when the app and wallet share a registrable suffix and you want Chrome/Firefox to surface credentials regardless of which subdomain is active.

Pros
- Works across subdomains of the app’s base domain.
- In Safari, top‑level bridging naturally matches the top‑level app domain, so ROR is not needed.

Cons
- Each distinct site needs its own credential (cannot reuse across unrelated domains like `example.com` and `web3authn.org`).
- If you previously registered credentials under the wallet domain, Chrome/Edge won’t show them after switching the `rpId`; users must re‑register.

How to implement (Option B)
1) Choose the app base domain as your rpId
   - Set `iframeWallet.rpIdOverride = '<app-base-domain>'` (e.g., `example.com` or `example.localhost`).
2) Keep bridge fallback for Safari
   - Set `enableSafariGetWebauthnRegistrationFallback: true` to cover rare focus/ancestor cases in Safari.
3) Permissions Policy and iframe `allow`
   - Same as Option A. The SDK sets the iframe `allow`; ensure your server sends a compatible `Permissions-Policy`.

Config snippet (Option B)
```ts
const passkey = new PasskeyManager({
  ...PASSKEY_MANAGER_DEFAULT_CONFIGS,
  relayer: { url: '…', accountId: '…' },
  iframeWallet: {
    walletOrigin: 'https://wallet.example.localhost',
    walletServicePath: '/service',
    rpIdOverride: 'example.localhost', // app base domain
    enableSafariGetWebauthnRegistrationFallback: true,
  },
});
```

Choosing at build/runtime
- Build‑time: hardcode `rpIdOverride` to the mode you want (wallet or app domain).
- Runtim …

…

## Testing Notes

- Browser matrix
  - Chromium (Chrome/Edge/Brave): Parent‑run with ROR for wallet‑scoped across unrelated sites; in‑iframe may work with delegated permissions, but top‑level execution is the consistent path.
  - Safari (macOS/iOS): Expect frequent bridge to top‑level; verify ROR behavior and focus handling.
  - Firefox: ROR not broadly shipped; validate app‑scoped fallback or show developer guidance.
- Migration behavior
  - Switching rpId changes which passkeys surface. Validate re‑registration prompts and guidance for users without matching credentials.
- Headers/CSP
  - Validate Permissions‑Policy and CSP in staging; missing/strict policies are the common cause of credential picker not appearing in iframes.

## NEAR Contract: ROR Allowlist

Back the `/.well-known/webauthn` manifest with an on‑chain allowlist.

- Storage
  - `allowed_origins: IterableSet<String>` — canonical, lowercase origins.
- View
  - `get_allowed_origins() -> Vec<String>` — returns sorted canonical origins.
- Change (admin-only)
  - `add_allowed_origin(origin: String) -> bool` — normalizes/validates and inserts; returns true when added.
  - `remove_allowed_origin(origin: String) -> bool` — normalizes and removes; returns true when removed.
  - `set_allowed_origins(origins: Vec<String>) -> bool` — bulk replace; normalizes, validates, dedupes; returns true.
- Origin format rules
  - Canonical: `scheme://host[:port]`, lowercase; schemes: `https` (or `http` only for `localhost`/`127.0.0.1`).
  - Not allowed: path, query, fragment, wildcards, spaces, trailing slash.
  - Host charset `[A-Za-z0-9.-]`; no leading/trailing `.` or `-`; port 1–65535 if present.
  - Limits: per‑origin length ≤ 255; max entries ≤ 5000; deduped.

## Serving `/.well-known/webauthn`

- Express relay server
  - `GET /.well-known/webauthn` returns `{ origins: [...] }` by calling the contract view and sanitizing. Adds `Cache-Control: max-age=60, stale-while-revalidate=600`.
- Cloudflare Worker relay
  - Same endpoint with env overrides: `ROR_CONTRACT_ID` (defaults to `WEBAUTHN_CONTRACT_ID`), `ROR_METHOD` (defaults to `get_allowed_origins`).
  - Same JSON shape and cache headers; existing CORS behavior applies.

## TODOs (implementation + rollout)

- Code
  - Keep VRF challenge generation and all WebAuthn flows using the same rpId resolver (done in SDK; verify in your app code paths).
  - Ensure bridging handlers stay aligned with rpId resolution and serialize credentials with PRF results.
- Dev/Docs
  - Document `VITE_ROR_ALLOWED_ORIGINS` in the app’s README and provide a sample dev `.env`.
  - Add example reverse‑proxy/CDN header snippets for Permissions‑Policy.
- Infra
  - Serve `/.well-known/webauthn` on the wallet domain listing allowed app origins.
  - Set Permissions‑Policy on the app domain to delegate to the wallet origin.
- QA
  - Cross‑browser manual pass (Chrome, Firefox, Safari desktop/iOS).
  - Test both modes (wallet‑scoped and app‑scoped) and switching between them with clear user prompts.

## Deploying a Wallet‑Scoped Site on web3authn.org

Goal: publish a dedicated wallet host that serves the wallet iframe and SDK assets from the wallet origin, and bind passkeys to `rpId = web3authn.org`.

This plan mirrors the `examples/vite-secure` approach, but targets a production Pages site at `https://web3authn.org` (or a subdomain you choose, e.g., `https://wallet.web3authn.org`).

1) Scaffold a new example: `examples/wallet-scoped-credentials`
- Copy `examples/vite-secure` and rename:
  - `cp -R examples/vite-secure examples/wallet-scoped-credentials`
  - Update `examples/wallet-scoped-credentials/package.json`:
    - `name`: `wallet-scoped-credentials`
    - Keep `build` and `preview` scripts; you can drop the local `dev`/Caddy bits if not needed.
- Ensure `examples/wallet-scoped-credentials/vite.config.ts` keeps the Web3Authn Vite plugins:
  - `web3authnDev(...)` for local serve
  - `web3authnBuildHeaders({ walletOrigin: env.VITE_WALLET_ORIGIN })` so a `_headers` file is emitted for Pages with COOP/COEP + Permissions‑Policy
- In `examples/wallet-scoped-credentials/src/main.tsx`, keep reading env for iframe config as in `vite-secure`:
  - `iframeWallet.walletOrigin = import.meta.env.VITE_WALLET_ORIGIN`
  - `iframeWallet.walletServicePath = import.meta.env.VITE_WALLET_SERVICE_PATH`
  - `iframeWallet.rpIdOverride = import.meta.env.VITE_RP_ID_BASE` (set to `web3authn.org` for wallet‑scoped)
- Add a production `.env` (or configure in Pages):
  - `VITE_WALLET_ORIGIN = https://web3authn.org` (or your wallet subdomain)
  - `VITE_WALLET_SERVICE_PATH = /wallet-service`
  - `VITE_SDK_BASE_PATH = /sdk`
  - `VITE_RP_ID_BASE = web3authn.org` (rpId bound to the wallet domain)
  - Relayer/NEAR network vars as in `examples/vite-secure/.env.development.local`.
- Add ROR (Related Origin Requests) manifest for cross‑origin embedding (top‑level app allowed to call WebAuthn for `rpId = web3authn.org`):
  - Create `examples/wallet-scoped-credentials/public/.well-known/webauthn` with JSON:
    
    ```json
    {
      "origins": [
        "https://<your-app-origin-1>",
        "https://<your-app-origin-2>"
      ]
    }
    ```
  - Adjust the list to all top‑level apps that embed the wallet.

2) Make the wallet service route resolve in production
- The dev plugin serves `GET /wallet-service`, but production needs a static page too.
- Two options:
  - A) Add a static file under `public` so Vite copies it to `dist/wallet-service/index.html`:
    - Path: `examples/wallet-scoped-credentials/public/wallet-service/index.html`
    - Contents:
      
      ```html
      <!doctype html>
      <html lang="en">
        <head>
          <meta charset="utf-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1" />
          <title>Web3Authn Wallet Service</title>
          <script>window.global ||= window; window.process ||= { env: {} };</script>
        </head>
        <body>
          <script type="module" src="/sdk/wallet-iframe-host.js"></script>
        </body>
      </html>
      ```
  - B) Use your Pages build step to generate the same file into the output dir (see the GitHub Actions section below).

3) Configure Cloudflare Pages project for the wallet site
- Create or select a Pages project to serve the wallet:
  - Custom domain: `web3authn.org` (apex) or a subdomain, e.g., `wallet.web3authn.org`.
