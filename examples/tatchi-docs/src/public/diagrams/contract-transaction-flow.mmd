sequenceDiagram
    box rgb(243, 244, 246) Iframe Wallet
    participant JSMain as JS Main Thread
    participant Worker as WASM Worker
    end
    participant NEAR as NEAR RPC
    participant Contract as Web3Authn Contract

    Note over JSMain,Worker: Phase 1: Preparation
    JSMain->>JSMain: 1. Validate action inputs
    JSMain->>JSMain: 2. Pre-warm NonceManager (async)

    Note over JSMain,Worker: Phase 2: User Confirmation & VRF Challenge
    JSMain->>Worker: 3. Request user confirmation
    Note over Worker: UI mounts showing transaction details
    Worker->>NEAR: 4. Get nonce, block height + hash
    NEAR->>Worker: Block data + nonce
    Worker->>Worker: 5. Generate VRF challenge (no TouchID)

    Note over JSMain,Worker: Phase 3: WebAuthn Authentication
    Worker->>Worker: 6. WebAuthn authentication (TouchID prompt)
    Worker->>Contract: 7. verify_authentication_response(vrf_data, webauthn_authentication)
    Contract->>Contract: 8. Verify VRF proof against stored VRF pubkey ✓
    Contract->>Contract: 9. Check freshness (block_height within MAX_BLOCK_AGE) ✓
    Contract->>Contract: 10. Verify WebAuthn signature against stored passkey ✓
    Contract->>Worker: 11. Authentication verified ✓

    Note over JSMain,Worker: Phase 4: Transaction Signing
    Worker->>Worker: 12. Sign NEAR transaction with ed25519 keypair
    Worker->>JSMain: 13. Signed transaction

    Note over JSMain,NEAR: Phase 5: Broadcasting
    JSMain->>NEAR: 14. Broadcast signed transaction
    NEAR->>JSMain: 15. Transaction result (txId)
    JSMain->>JSMain: 16. Update nonce from blockchain (async)
    JSMain->>JSMain: 17. Transaction complete ✓
