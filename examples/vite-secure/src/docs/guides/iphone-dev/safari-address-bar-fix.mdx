Safari iOS address bar/clipping fix – progress log

Problem

- iOS Safari 16+ (incl. iOS 18/Safari 26) clips `position: fixed` to the inner/visual viewport. Backdrops stop at the Safari UI bars, so a seam appears above/below modals and drawers.

What we tried (chronological)

- Absolute backdrops inside Lit components
  - Files: `IframeTxConfirmer/viewer-modal.ts`, `LitComponents/Drawer/index.ts`
  - Switched modal/drawer backdrops to `position: absolute` with page sizing and added a sticky wrapper to keep content in view.
  - Result: improves sizing inside their own documents, but does not fix the seam when the overlayed wallet-iframe itself is clipped to the visual viewport.

- Page height CSS var (`--w3a-page-height`) + visualViewport listeners
  - Files: modal/drawer components and hosts set `--w3a-page-height` from `document.body.clientHeight` and update on `resize/orientationchange/scroll/visualViewport.resize`.
  - Result: reliable page-height within each document, but not sufficient alone when the parent overlay is still fixed to the inner viewport.

- Iframe modal host outer shims
  - File: `IframeTxConfirmer/tx-confirmer-wrapper.ts`
  - Added page-anchored top/bottom overlays sized from `visualViewport` offsets to tint under the bars (above the iframe).
  - Result: seam still visible in device testing.

- Wallet overlay absolute (page-anchored)
  - File: `WalletIframe/client/overlay-controller.ts`
  - Attempted switching wallet overlay from fixed → absolute to cover under bars.
  - Result: regression — overlay anchored to document; when page was scrolled, the overlay was no longer in view.

- Drawer body-portal overlay (page-anchored)
  - File: `LitComponents/Drawer/index.ts`
  - Added a body-level overlay (portal) sized to page height, updated with `visualViewport` metrics; anchors `html/body` while drawer is open.
  - Result: seam still visible in device testing.

Current status

- Bug is not resolved. On iOS 26, we still see the backdrop stopping at (or mismatching) the Safari address bars for both modal and drawer.

Next steps (concrete)

- Instrumentation build:
  - Log and visually render `vv.offsetTop`, `vv.height`, computed `vvBottom`, `pageHeight`, and the active overlay z-indexes to confirm where mismatch occurs on-device.
- Unify overlay tokens:
  - Use a shared CSS variable (e.g., `--w3a-overlay-dim`) for dim color across host outer shims and iframe backdrops to remove subtle seams.
- Single host overlay strategy:
  - Prefer a single page-anchored overlay at the app host level (above the fixed wallet iframe) sized: `height = max(scrollHeight, vv.height + top + bottom)`, pointer-events: none. Let the iframe render only content, not another dim layer.
- If accuracy still fails:
  - Compute host overlay height from `max(documentElement.scrollHeight, body.scrollHeight, documentElement.clientHeight, visualViewport.height + offsets)` on every `visualViewport` and `resize` event.

References
- https://github.com/mui/base-ui/issues/2799
- https://github.com/mui/material-ui/issues/46953
- https://x.com/devongovett/status/1968384768703349198

---

## Analysis (2025-10-07)

### Root Cause

On iOS Safari 16+ (including iOS 18/Safari 26):
1. **`position: fixed` clips to the visual viewport** - excludes the Safari UI bars (address bar, toolbar)
2. **The wallet iframe compounds the problem** - The iframe itself may be clipped, and then the modal/drawer inside has its own clipping
3. **Layout vs Visual viewport mismatch** - The visual viewport shrinks when Safari's chrome is visible, but `position: fixed` elements don't extend beyond it

### Key Insights from MUI Issues

**From Base-UI #2799:**
- Solution: Use `position: absolute` with `height: var(--body-client-height)`
- The CSS variable must be updated on `resize`, `scroll`, `orientationchange`, and `visualViewport.resize` events
- Works correctly across Safari UI states (collapsed chrome, scrolled, different tab layouts)

**From Material-UI #46953:**
- The backdrop stops at the visual viewport boundary
- Without proper handling, gaps appear above/below modals
- The issue is exacerbated inside iframes
- `viewport-fit=cover` meta tag is critical for extending content under safe areas

---

## Recommended Solutions

### Solution 1: Switch Backdrops to `position: absolute` ✅ PRIORITY

**Problem:** `position: fixed` with `inset: 0` clips to visual viewport on iOS Safari.

**Fix:** Use `position: absolute` with dynamically-calculated page height.

**Files to update:**
- `passkey-sdk/src/core/WebAuthnManager/LitComponents/IframeTxConfirmer/viewer-modal.ts`
- `passkey-sdk/src/core/WebAuthnManager/LitComponents/IframeTxConfirmer/viewer-drawer.ts`
- `passkey-sdk/src/core/WebAuthnManager/LitComponents/Drawer/index.ts` (if applicable)

**CSS changes:**
```css
.modal-backdrop-blur,
.modal-backdrop {
  position: absolute;  /* was: fixed */
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  height: var(--w3a-page-height, 100vh);
  min-height: 100vh;
}
```

**JavaScript changes:**
Add viewport tracking to update `--w3a-page-height` on:
- `window.visualViewport.resize`
- `window.visualViewport.scroll`
- `window.resize`
- `window.orientationchange`

Calculate height as:
```typescript
const pageHeight = visualViewport
  ? Math.max(
      document.documentElement.scrollHeight,
      document.body.scrollHeight,
      document.documentElement.clientHeight,
      visualViewport.height + visualViewport.offsetTop +
        (window.innerHeight - visualViewport.height - visualViewport.offsetTop)
    )
  : Math.max(
      document.documentElement.scrollHeight,
      document.body.scrollHeight,
      document.documentElement.clientHeight
    );
```

### Solution 2: Lock Body Scroll When Overlays are Open

**Problem:** Page scrolling can cause backdrop/overlay misalignment.

**Fix:** Lock `html` and `body` with `position: fixed` while modal/drawer is open.

**Implementation:**
- In `connectedCallback`: apply `position: fixed` to html/body, store scroll position
- In `disconnectedCallback`: restore scroll position, remove fixed positioning

### Solution 3: Ensure HTML/Body Sizing in Iframe

**Problem:** Iframe document may not extend to full viewport height.

**Fix:** Add base styles to wallet iframe host document.

**File:** `passkey-sdk/src/core/WalletIframe/host/wallet-iframe-host.ts`

**Add at initialization:**
```css
html, body {
  min-height: 100vh;
  min-height: -webkit-fill-available;
  position: relative;
}
html {
  height: 100%;
}
body {
  min-height: 100%;
}
```

### Solution 4: Unify Overlay Colors

**Problem:** Subtle color differences between host shims and iframe backdrops create visible seams.

**Fix:** Use shared `--w3a-overlay-dim` CSS variable across all overlay layers.

**Files:**
- viewer-modal.ts
- viewer-drawer.ts
- Any host-level overlay shims

### Solution 5: Verify Meta Viewport Tag

**Problem:** Without `viewport-fit=cover`, content won't extend under iOS safe areas.

**Fix:** Ensure parent app and iframe have:
```html
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
```

---

## Implementation Plan

### Phase 1: Core Backdrop Fix (P0 - Critical)
**Estimated effort:** 2-3 hours

1. **Update viewer-modal.ts:**
   - [ ] Change `.modal-backdrop-blur` and `.modal-backdrop` from `position: fixed` to `position: absolute`
   - [ ] Add `height: var(--w3a-page-height, 100vh)` and `min-height: 100vh`
   - [ ] Add `updatePageHeight()` method
   - [ ] Add viewport event listeners in `connectedCallback()`
   - [ ] Remove listeners in `disconnectedCallback()`
   - [ ] Add body scroll lock on mount, unlock on unmount

2. **Update viewer-drawer.ts:**
   - [ ] Apply same backdrop positioning changes as modal
