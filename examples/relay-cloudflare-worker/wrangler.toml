name = "w3a-relay-prod"
main = "src/worker.ts"
compatibility_date = "2024-09-24"
compatibility_flags = ["nodejs_compat"]

# Configure module rules for WASM imports
[[rules]]
type = "CompiledWasm"
globs = ["**/*.wasm"]
fallthrough = true

# Durable Object for threshold session persistence (Cloudflare-native; required for prod threshold signing).
[[durable_objects.bindings]]
name = "THRESHOLD_STORE"
class_name = "ThresholdEd25519StoreDurableObject"

[[migrations]]
tag = "v2"
# Cloudflare Free plan requires SQLite-backed Durable Objects.
new_sqlite_classes = ["ThresholdEd25519StoreDurableObject"]

# Default inactive; add a cron schedule here when you enable rotation or heartbeats.
[triggers]
crons = []

[vars]
RELAYER_ACCOUNT_ID = "w3a-relayer.testnet"
NEAR_RPC_URL = "https://test.rpc.fastnear.com"
NETWORK_ID = "testnet"
# Align with src/worker.ts Env: WEBAUTHN_CONTRACT_ID
WEBAUTHN_CONTRACT_ID = "w3a-v1.testnet"
ACCOUNT_INITIAL_BALANCE = "40000000000000000000000" # 0.04 NEAR
CREATE_ACCOUNT_AND_REGISTER_GAS = "85000000000000"  # 85 TGas
RELAYER_URL = "https://relay.tatchi.xyz"
THRESHOLD_PREFIX = "tatchi:prod:w3a"
THRESHOLD_ED25519_SHARE_MODE = "derived"

# Secrets are NOT defined here. Set them via Wrangler secrets (they persist across deploys):
#   wrangler secret put RELAYER_PRIVATE_KEY
#   wrangler secret put SHAMIR_P_B64U
#   wrangler secret put SHAMIR_E_S_B64U
#   wrangler secret put SHAMIR_D_S_B64U
# Required at runtime by src/worker.ts

# Optional CORS (production allowlist)
EXPECTED_ORIGIN = "https://tatchi.xyz"
EXPECTED_WALLET_ORIGIN = "https://wallet.web3authn.org"

# Production worker env (explicit; matches GitHub Environment name)
[env.production]
name = "w3a-relay-prod"

[env.production.vars]
RELAYER_ACCOUNT_ID = "w3a-relayer.testnet"
NEAR_RPC_URL = "https://test.rpc.fastnear.com"
NETWORK_ID = "testnet"
WEBAUTHN_CONTRACT_ID = "w3a-v1.testnet"
ACCOUNT_INITIAL_BALANCE = "40000000000000000000000" # 0.04 NEAR
CREATE_ACCOUNT_AND_REGISTER_GAS = "85000000000000"  # 85 TGas
RELAYER_URL = "https://relay.tatchi.xyz"
EXPECTED_ORIGIN = "https://tatchi.xyz"
EXPECTED_WALLET_ORIGIN = "https://wallet.web3authn.org"
THRESHOLD_PREFIX = "tatchi:prod:w3a"
THRESHOLD_ED25519_SHARE_MODE = "derived"

# Durable Object binding (explicit per-env to avoid any inheritance ambiguity).
[[env.production.durable_objects.bindings]]
name = "THRESHOLD_STORE"
class_name = "ThresholdEd25519StoreDurableObject"

# Staging worker (separate Worker name + tighter CORS allowlist)
[env.staging]
name = "w3a-relay-staging"

[env.staging.vars]
RELAYER_ACCOUNT_ID = "w3a-relayer.testnet"
NEAR_RPC_URL = "https://test.rpc.fastnear.com"
NETWORK_ID = "testnet"
WEBAUTHN_CONTRACT_ID = "w3a-v1.testnet"
ACCOUNT_INITIAL_BALANCE = "40000000000000000000000" # 0.04 NEAR
CREATE_ACCOUNT_AND_REGISTER_GAS = "85000000000000"  # 85 TGas
RELAYER_URL = "https://relay-staging.tatchi.xyz"
EXPECTED_ORIGIN = "https://staging.tatchi.xyz"
EXPECTED_WALLET_ORIGIN = "https://wallet-staging.web3authn.org"
THRESHOLD_PREFIX = "tatchi:staging:w3a"
THRESHOLD_ED25519_SHARE_MODE = "derived"

# Durable Object binding (explicit per-env to avoid any inheritance ambiguity).
[[env.staging.durable_objects.bindings]]
name = "THRESHOLD_STORE"
class_name = "ThresholdEd25519StoreDurableObject"

# Optional: explicitly enable cron and rotation (defaults to disabled)
# ENABLE_ROTATION = "0"

# Optional: Threshold signing (2-party FROST).
#
# This Worker example enables threshold signing only when the master secret is provided:
#   wrangler secret put THRESHOLD_ED25519_MASTER_SECRET_B64U

# Observability (Workers Logs). Requires appropriate Cloudflare plan.
[observability]
  [observability.logs]
  enabled = true
  head_sampling_rate = 1
  invocation_logs = true
