name = "w3a-relay"
main = "src/worker.ts"
compatibility_date = "2024-09-24"
compatibility_flags = ["nodejs_compat"]

# Use custom esbuild configuration for WASM modules
[build]
command = ""

[build.custom_build]
# Tell esbuild to use binary loader for WASM
esbuild_config = "esbuild.config.js"

# Configure module rules for WASM imports
[[rules]]
type = "CompiledWasm"
globs = ["**/*.wasm"]
fallthrough = true

# Default inactive; add a cron schedule here when you enable rotation or heartbeats.
[triggers]
crons = []

[vars]
RELAYER_ACCOUNT_ID = "w3a-relayer.testnet"
NEAR_RPC_URL = "https://test.rpc.fastnear.com"
NETWORK_ID = "testnet"
# Align with src/worker.ts Env: WEBAUTHN_CONTRACT_ID
WEBAUTHN_CONTRACT_ID = "w3a-v1.testnet"
ACCOUNT_INITIAL_BALANCE = "40000000000000000000000" # 0.04 NEAR
CREATE_ACCOUNT_AND_REGISTER_GAS = "85000000000000"  # 85 TGas
RELAYER_URL = "https://relay.tatchi.xyz"

# Secrets are NOT defined here. Set them via Wrangler secrets (they persist across deploys):
#   wrangler secret put RELAYER_PRIVATE_KEY
#   wrangler secret put SHAMIR_P_B64U
#   wrangler secret put SHAMIR_E_S_B64U
#   wrangler secret put SHAMIR_D_S_B64U
# Required at runtime by src/worker.ts

# Optional CORS
EXPECTED_ORIGIN = "https://tatchi.xyz, https://staging.tatchi.xyz"
EXPECTED_WALLET_ORIGIN = "https://wallet.web3authn.org, https://wallet-staging.web3authn.org"

# Optional: explicitly enable cron and rotation (defaults to disabled)
# ENABLE_ROTATION = "0"

# Optional: Threshold signing (2-party FROST).
#
# This Worker example enables threshold signing only when the master secret is provided:
#   wrangler secret put THRESHOLD_ED25519_MASTER_SECRET_B64U

# Observability (Workers Logs). Requires appropriate Cloudflare plan.
[observability]
  [observability.logs]
  enabled = true
  head_sampling_rate = 1
  invocation_logs = true
  persist = true
